<div class="container mt-4 mb-5">
  <h2 class="mb-4"><i class="bi bi-credit-card me-2"></i>Finalizar Compra</h2>

  <div class="row">
    <div class="col-lg-8">
      <!-- Tipo de Entrega -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-truck me-2"></i>Tipo de Entrega</h5>
        </div>
        <div class="card-body">
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" [(ngModel)]="tipoEntrega" 
                   value="ENVIO" id="envio">
            <label class="form-check-label" for="envio">
              <strong>Envío a domicilio</strong> - S/ {{costoEnvio.toFixed(2)}}
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" [(ngModel)]="tipoEntrega" 
                   value="RECOJO_EN_TIENDA" id="recojo">
            <label class="form-check-label" for="recojo">
              <strong>Recojo en tienda</strong> - Gratis
            </label>
          </div>
        </div>
      </div>

      <!-- Dirección de Envío -->
      <div class="card shadow-sm mb-4" *ngIf="tipoEntrega === 'ENVIO'">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Dirección de Envío</h5>
          <button class="btn btn-sm btn-light" (click)="toggleFormDireccion()">
            <i class="bi bi-plus-circle me-1"></i>Nueva
          </button>
        </div>
        <div class="card-body">
          <!-- Lista de direcciones -->
          <div *ngIf="!mostrarFormDireccion">
            <div *ngIf="direcciones.length === 0" class="text-center text-muted py-3">
              No tienes direcciones guardadas. Agrega una nueva.
            </div>

            <div class="form-check mb-3" *ngFor="let dir of direcciones">
              <input class="form-check-input" type="radio" 
                     [value]="dir.idDireccion" 
                     [(ngModel)]="idDireccionSeleccionada"
                     [id]="'dir-' + dir.idDireccion">
              <label class="form-check-label w-100" [for]="'dir-' + dir.idDireccion">
                <div class="d-flex justify-content-between">
                  <div>
                    <strong>{{dir.nombreDestinatario}}</strong>
                    <span class="badge bg-success ms-2" *ngIf="dir.esPrincipal">Principal</span>
                    <p class="mb-0 text-muted small">{{dir.direccionLinea1}}</p>
                    <p class="mb-0 text-muted small">
                      {{dir.distrito}}, {{dir.provincia}}, {{dir.departamento}}
                    </p>
                    <p class="mb-0 text-muted small">Tel: {{dir.telefonoDestinatario}}</p>
                  </div>
                </div>
              </label>
            </div>
          </div>

          <!-- Formulario nueva dirección -->
          <div *ngIf="mostrarFormDireccion">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombre completo *</label>
                <input type="text" class="form-control" [(ngModel)]="nuevaDireccion.nombreDestinatario" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Teléfono *</label>
                <input type="tel" class="form-control" [(ngModel)]="nuevaDireccion.telefonoDestinatario" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Departamento *</label>
                <input type="text" class="form-control" [(ngModel)]="nuevaDireccion.departamento" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Provincia *</label>
                <input type="text" class="form-control" [(ngModel)]="nuevaDireccion.provincia" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Distrito *</label>
                <input type="text" class="form-control" [(ngModel)]="nuevaDireccion.distrito" required>
              </div>
              <div class="col-12">
                <label class="form-label">Dirección *</label>
                <input type="text" class="form-control" [(ngModel)]="nuevaDireccion.direccionLinea1" 
                       placeholder="Ej: Av. Principal 123" required>
              </div>
              <div class="col-12">
                <label class="form-label">Referencia</label>
                <textarea class="form-control" [(ngModel)]="nuevaDireccion.referencia" 
                          rows="2" placeholder="Ej: Frente al parque"></textarea>
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" 
                         [(ngModel)]="nuevaDireccion.esPrincipal" id="principal">
                  <label class="form-check-label" for="principal">
                    Establecer como dirección principal
                  </label>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-primary me-2" (click)="guardarDireccion()">
                  <i class="bi bi-save me-2"></i>Guardar
                </button>
                <button class="btn btn-outline-secondary" (click)="toggleFormDireccion()">
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Método de Pago -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i>Método de Pago</h5>
        </div>
        <div class="card-body">
          <div class="form-check mb-3" *ngFor="let metodo of metodosPago">
            <input class="form-check-input" type="radio" 
                   [value]="metodo.idMetodoPago" 
                   [(ngModel)]="idMetodoPagoSeleccionado"
                   [id]="'metodo-' + metodo.idMetodoPago">
            <label class="form-check-label" [for]="'metodo-' + metodo.idMetodoPago">
              <strong>{{metodo.nombreMetodo}}</strong>
              <p class="mb-0 text-muted small">{{metodo.descripcion}}</p>
            </label>
          </div>
        </div>
      </div>

      <!-- Notas -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-chat-text me-2"></i>Notas del Pedido</h5>
        </div>
        <div class="card-body">
          <textarea class="form-control" rows="3" [(ngModel)]="notas"
                    placeholder="¿Alguna indicación especial? (opcional)"></textarea>
        </div>
      </div>
    </div>

    <!-- Resumen del Pedido -->
    <div class="col-lg-4">
      <div class="card shadow-sm sticky-top" style="top: 80px;">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Resumen del Pedido</h5>
        </div>
        <div class="card-body" *ngIf="carrito">
          <div class="mb-3">
            <h6>Productos ({{carrito.totalItems}})</h6>
            <div class="small mb-2" *ngFor="let detalle of carrito.detalles">
              <div class="d-flex justify-content-between">
                <span>{{detalle.nombreProducto}} x{{detalle.cantidad}}</span>
                <span>S/ {{detalle.subtotal.toFixed(2)}}</span>
              </div>
            </div>
          </div>
          
          <hr>
          
          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal</span>
            <span>S/ {{carrito.totalGeneral.toFixed(2)}}</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Envío</span>
            <span>S/ {{tipoEntrega === 'ENVIO' ? costoEnvio.toFixed(2) : '0.00'}}</span>
          </div>
          
          <hr>
          
          <div class="d-flex justify-content-between mb-3">
            <strong class="fs-5">Total</strong>
            <strong class="fs-5 text-success">S/ {{getTotal().toFixed(2)}}</strong>
          </div>
          
          <button class="btn btn-success btn-lg w-100" 
                  (click)="finalizarCompra()" 
                  [disabled]="procesando">
            <i class="bi bi-check-circle me-2"></i>
            <span *ngIf="!procesando">Confirmar Pedido</span>
            <span *ngIf="procesando">Procesando...</span>
          </button>
          
          <a routerLink="/carrito" class="btn btn-outline-secondary w-100 mt-2">
            <i class="bi bi-arrow-left me-2"></i>Volver al Carrito
          </a>
        </div>
      </div>
    </div>
  </div>
</div>